<!DOCTYPE html>
<html>
    <head>
            <link rel="stylesheet" href="index.css" type="text/css">
            <!-- Bootstrap CSS -->
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
            <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
            <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    </head>
<body style="background: #f9f9f9">
<!-- Image and text -->
    <nav class="navbar navbar-light">
        <a class="navbar-brand" href="#">
            <img src="assets/logo.png" width="40" height="40" class="d-inline-block align-top" alt="">
            <span class="navbar-brand mb-0 h1" id="title">PatientPal</span>
        </a>
    </nav>

    <div ng-controller="mainCtrl"><div class="bd-example">
        <div id="page-wrapper">
            <div class="column" id="chart">
                <div ng-repeat="x in questions" on-finish-render="ngRepeatFinished">
                    <div ng-attr-id="{{ 'object-' + $index}}" ></div>
                </div>
            </div>
            <div class="column" id="total-con">
                <div id="total">
                    <h5>Total Submissions:</h5>
                </div>
                <div>
                    <!-- DISPLAY TOTAL HERE -->
                    <h5>344</h5>
                </div>
            </div>
            <div class="column" id="total-con">
                <div class="total2" id="tt2">
                    <div>
                        <p>Note: <br />
                            Below are the combined totals for each question answered.

                        </p>
                    </div>
                </div>
            </div>
            <div class="column" id="total-con">
                <div class="total2">
                    <div class="t1">
                        <p>What is your age?</p>
                    </div>
                    <div class="t2">
                        <!-- DISPLAY TOTAL HERE -->
                        <p class="tot-q">14</p>
                    </div>
                </div>
            </div>
            <div class="column" id="total-con">
                <div class="total2">
                    <div class="t1">
                        <p>How far away do you live to the nearest hospital?</p>
                    </div>
                    <div class="t2">
                        <!-- DISPLAY TOTAL HERE -->
                        <p class="tot-q">23</p>
                    </div>
                </div>
            </div>
            <div class="column" id="total-con">
                <div class="total2">
                    <div class="t1">
                        <p>Have you known anyone who has had cancer?</p>
                    </div>
                    <div class="t2">
                        <!-- DISPLAY TOTAL HERE -->
                        <p class="tot-q">34</p>
                    </div>
                </div>
            </div>
            <div class="column" id="total-con">
                <div class="total2">
                    <div class="t1">
                        <p>Do you find value in a software that provides patients with the ability to update their quality of life for doctors to monitor?</p>
                    </div>
                    <div class="t2">
                        <!-- DISPLAY TOTAL HERE -->
                        <p class="tot-q">5</p>
                    </div>
                </div>
            </div>
        </div>

            
        
    </div>

    <script>

        /* Controllers */
        google.load('visualization', '1', {
            packages: ['corechart']
        });

        google.setOnLoadCallback(function() {
            angular.bootstrap(document.body, ['analyticsApplication']);
        });

        var app = angular.module('analyticsApplication', []);
        app.directive('onFinishRender', function ($timeout) {
            return {
                restrict: 'A',
                link: function (scope, element, attr) {
                    if (scope.$last === true) {
                        $timeout(function () {
                            google.charts.load('current', {'packages':['bar']});                            
                            scope.$emit(attr.onFinishRender);
                        });
                    }
                }
            }
        });

        app.controller('mainCtrl', function ($scope, $http) {

            let obj = {}; // Stores all the questions 
            let rowOptions = []; // Stores row options
            let columnOptions = []; // Stores column options

            // Compares question name
            var question;

            // HTTP GET request to backend.
            // Retrieves JSON obj of questions
            $http.get("/responses").then(function (response) {
            console.log(response);
            $scope.questions = response.data.Questions;
            obj = $scope.questions; 
            }).then(() => {
                // Sorts row and column options
                obj.forEach((item, index, array) => {
                    columnOptions[index] = item.columns.map(element => {
                        return element
                    });
                    rowOptions[index] = item.rows.map(element => {
                        return element;
                    });
                });
                console.log(rowOptions);
            }).catch(function(err){
                alert(err.message);
            });
            

            // Draws a chart.
            $scope.$on('ngRepeatFinished', (ngRepeatFinishedEvent) => {

                obj.forEach((item, index, array) => {
                    // Create the data table.
                    var data = new google.visualization.DataTable();

                    // Define row options
                    columnOptions[index].forEach(element => {
                        data.addColumn(element[0], element[1]);
                    });
                    
                    // Define row options
                    rowOptions[index].forEach(element => {
                        console.log(element);
                        data.addRow(element);
                    });
                    
                    // // Set chart options
                    var options = {'title': obj[index].Name,
                       'width':500,
                       'height':300,
                        'backgroundColor': '#f9f9f9'};

                    var chart;

                    // Only displaying four questions 
                    if(index == 0 || index == 3) {
                        chart = new google.visualization.PieChart(document.getElementById('object-' + index));
                        chart.draw(data, options);
                    } else if (index == 1 || index == 2){
                        chart = new google.visualization.BarChart(document.getElementById('object-' + index));
                        chart.draw(data, options);
                    } else {
                        console.log("Invalid Index");
                    }
                });
            });
        });
    </script>

</body>

</html>
